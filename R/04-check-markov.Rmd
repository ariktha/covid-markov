---
title: "Markov models for COVID-19 clinical trajectories: Check Markovian assumption"
author: "Ariktha Srivathsan"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())

library(here)
library(tidyverse)
library(kableExtra)
library(tibble)
library(msm)
library(splines)
library(furrr)
library(stringr)
library(reshape2)
```

```{r Load data and functions, include = FALSE}
source(here("scripts", "00-config.R"))
source(here("scripts", "00-functions.R"))

# Load data
pt_stg_raw <- readRDS(here("data", "temp", "pt_stg.rds"))
pt_stg <- pt_stg_raw %>% dplyr::filter(model == "hx_sev")

fitted_models <- readRDS(here("data", "temp", "models.rds"))
crude_rates <- readRDS(here("data", "temp", "mod_crude_rates.rds"))
qmat_list <- readRDS(here("data", "temp", "mod_qmat_list.rds"))

```

## Descriptives of Time spent in Severe (`hx_sev_time`) at discharge

```{r Descriptives of time in severe, echo = FALSE, fig.height=4, fig.width=6}
# Get final observation per patient
end_hx_sev <- pt_stg %>%
  group_by(deid_enc_id) %>%
  arrange(DaysSinceEntry) %>%
  slice_tail(n = 1) %>%
  ungroup()

# Create filtered dataset (non-zero hx_sev_time)
end_hx_sev_nonzero <- end_hx_sev %>%
  dplyr::filter(hx_sev_time > 0)

# Count percent with hx_sev_time == 0
n_total <- nrow(end_hx_sev)
n_zero <- sum(end_hx_sev$hx_sev_time == 0, na.rm = TRUE)
percent_zero <- round(100 * n_zero / n_total, 1)

# Histogram
p <- ggplot(end_hx_sev_nonzero, aes(x = hx_sev_time)) +
  geom_histogram(binwidth = 1, boundary = 0, closed = "left", fill = "steelblue", color = "white") +
  labs(
    x = "Days previously spent in Severe state (non-zero only)",
    y = "Number of encounters",
    title = "Distribution of time in Severe state at discharge (non-zero)"
  ) +
  theme_minimal()

print(p)

# Summary table
hx_summary <- summary(end_hx_sev_nonzero$hx_sev_time) %>%
  as.list() %>%
  enframe(name = "stat", value = "value")

hx_summary %>%
  kable(caption = "Summary statistics for non-zero time in Severe state (days)") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover")) %>%
  footnote(
    general = paste0(percent_zero, "% of patients (", n_zero, " of ", n_total, ") had 0 days in Severe at discharge/death"),
    general_title = "Note:"
  )
```


## History‑of‑Severe as a separate state (5‑state model)

```{r hx sev state comp fit}

# hx_draic <- draic.msm(fitted_models[["hx_sev"]], fitted_models[["base_model"]])
# hx_drlcv <- drlcv.msm(fitted_models[["hx_sev"]], fitted_models[["base_model"]], cores = n.cores)
hx_lrt <- lrtest.msm(fitted_models[["base_model"]], fitted_models[["hx_sev"]])

hx_comp_fit <- tibble(
  model2_name = c("hx_sev"),
  model1_name = c("base_model"),
  # draic = list(hx_draic),
  # drlcv = list(hx_drlcv),
  lrt = list(hx_lrt)
)

hx_comp_nstate <- hx_comp_fit %>%
  mutate(
    # draic_val = map_dbl(draic, ~.x$draic),
    # draic_ll = map_dbl(draic, ~.x$ti["2.5%"]),
    # draic_ul = map_dbl(draic, ~.x$ti["97.5%"]),
    # draic_pval = map_dbl(draic, ~.x$ti["Prob<0"]),
    # drlcv_val = map_dbl(drlcv, ~.x$drlcv),
    # drlcv_ll = map_dbl(drlcv, ~.x$ti["2.5%"]),
    # drlcv_ul = map_dbl(drlcv, ~.x$ti["97.5%"]),
    # drlcv_pval = map_dbl(drlcv, ~.x$ti["Prob<0"]),
    lr_stat     = hx_lrt[1],
    lr_df       = hx_lrt[2],
    lr_pval     = hx_lrt[3]
  ) %>%
  dplyr::select(model1_name, model2_name,
                # draic = draic_val, draic_ll, draic_ul, draic_pval,
                # drlcv = drlcv_val, drlcv_ll, drlcv_ul, drlcv_pval,
                lr_stat, lr_df, lr_pval)
  
hx_comp_nstate %>%
  kableExtra::kable(caption = "Model comparison for including a history of Severe state")

```

```{r hx sev state comp qmat}

state_order <- c("M", "MS", "S", "D", "R")
transition_order <- c("M→M", "MS→MS", "M→S", "MS→S", "M→D", "MS→D", "M→R", "MS→R", "S→M", "S→MS", "S→S", "S→D", "S→R")

allowed_transitions <- rbind(as.data.frame(as.table(qmat_list[["base_model"]])), as.data.frame(as.table(qmat_list[["hx_sev"]])))
names(allowed_transitions) <- c("From", "To", "Allowed")
allowed_transitions <- subset(allowed_transitions, Allowed == 1) %>% distinct()

q_base <- qmatrix.msm(fitted_models[["base_model"]], covariates = "mean", ci = "none")
q_hx   <- qmatrix.msm(fitted_models[["hx_sev"]], covariates = "mean", ci = "none")

q_base_df <- as.data.frame(as.table(q_base))
names(q_base_df) <- c("From", "To", "Rate")
q_base_df$Model <- "Base"

q_hx_df <- as.data.frame(as.table(q_hx))
names(q_hx_df) <- c("From", "To", "Rate")
q_hx_df$Model <- "Hx_sev"

q_combined <- rbind(q_base_df, q_hx_df) %>%
  inner_join(allowed_transitions, by = c("From", "To"))

q_combined$From <- factor(q_combined$From, levels = state_order)
q_combined$To   <- factor(q_combined$To, levels = state_order)
q_combined$Transition <- interaction(q_combined$From, q_combined$To, sep = "→")

q_combined <- q_combined %>%
  dplyr::filter(!From %in% c("D", "R")) %>%
  arrange(From, To) %>%
  mutate(Transition = factor(Transition, levels = transition_order))

ggplot(q_combined, aes(x = Transition, y = Rate, fill = Model)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Transition Intensities (Q Matrix)", x = "Transition", y = "Intensity")

```

```{r hx sev state comp sojourn}

# Sojourn times (only for non-absorbing states)
soj_base <- sojourn.msm(fitted_models[["base_model"]], covariates = "mean")
soj_hx   <- sojourn.msm(fitted_models[["hx_sev"]], covariates = "mean")

soj_base$State <- rownames(soj_base)
soj_base$Model <- "Base"

soj_hx$State <- rownames(soj_hx)
soj_hx$Model <- "Hx_sev"

# Combine and reorder
sojourn_df <- rbind(soj_base, soj_hx)

# Only plot common states (e.g., exclude MS for Base)
sojourn_df <- sojourn_df %>%
  filter(!(Model == "Base" & State == "MS")) %>%
  mutate(
    State = factor(State, levels = state_order),
    Model = factor(Model),
    State_Label = paste0(State, " (", Model, ")")
  )

ggplot(sojourn_df, aes(x = State, y = estimates, fill = Model)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  geom_errorbar(aes(ymin = L, ymax = U), width = 0.2, position = position_dodge(width = 0.9)) +
  theme_minimal() +
  labs(title = "Mean Sojourn Times with 95% CI", x = "State", y = "Sojourn Time (Days)") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)))

```


```{r hx sev state comp pmat, echo=FALSE}

# Extract 5-day P matrices
p_base <- pmatrix.msm(fitted_models[["base_model"]], t = 5)
p_hx   <- pmatrix.msm(fitted_models[["hx_sev"]], t = 5)

# Convert to data frame
p_base_df <- as.data.frame(as.table(p_base))
names(p_base_df) <- c("From", "To", "Prob")
p_base_df$Model <- "Base"

p_hx_df <- as.data.frame(as.table(p_hx))
names(p_hx_df) <- c("From", "To", "Prob")
p_hx_df$Model <- "Hx_sev"

# Combine and filter using allowed transitions
p_combined <- rbind(p_base_df, p_hx_df) %>%
  inner_join(allowed_transitions, by = c("From", "To"))

# Reorder and label
p_combined$From <- factor(p_combined$From, levels = state_order)
p_combined$To   <- factor(p_combined$To, levels = state_order)
p_combined$Transition <- interaction(p_combined$From, p_combined$To, sep = "→")

p_combined <- p_combined %>%
  dplyr::filter(!From %in% c("D", "R")) %>%
  arrange(From, To) %>%
  mutate(Transition = factor(Transition, levels = transition_order))

# Plot
ggplot(p_combined, aes(x = Transition, y = Prob, fill = Model)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "5-Day Transition Probabilities", x = "Transition", y = "Probability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```


## Time spent in Severe (`hx_sev_time`) as a covariate

### 5‑state model with and without `hx_sev_time` as a covariate

```{r fit-4state-hx-cov}
msm_5_hx_cov <- msm(
  state_num ~ DaysSinceEntry,
  subject     = deid_enc_id,
  data        = pt_stg,
  qmatrix     = crude_rates[["hx_sev"]]$qmat,
  covariates  = ~ hx_sev_time,
  control     = list(fnscale = 10000, maxit = 1000)
)

# Did not converge so setting hx_sev_time > 30 to 30

pt_stg <- pt_stg %>%
  mutate(hx_sev_time_trunc = ifelse(hx_sev_time > 30, 30, hx_sev_time)) %>%
  mutate(hx_sev_time_cat = case_when(
    hx_sev_time_trunc == 0 ~ "0 days",
    hx_sev_time_trunc <= 7 ~ "1-7 days",
    hx_sev_time_trunc <= 14 ~ "8-14 days",
    TRUE ~ "14+ days"
  ))

msm_5_hx_cov_trunc <- msm(
  state_num ~ DaysSinceEntry,
  subject     = deid_enc_id,
  data        = pt_stg,
  qmatrix     = crude_rates[["hx_sev"]]$qmat,
  covariates  = ~ hx_sev_time_trunc,
  control     = list(fnscale = 10000, maxit = 1000)
)

msm_5_hx_cov_cat <- msm(
  state_num ~ DaysSinceEntry,
  subject     = deid_enc_id,
  data        = pt_stg,
  qmatrix     = crude_rates[["hx_sev"]]$qmat,
  covariates  = ~ hx_sev_time_cat,
  control     = list(fnscale = 10000, maxit = 1000)
)

spline_basis <- as.data.frame(splines::ns(pt_stg$hx_sev_time, df = 3))
names(spline_basis) <- paste0("hx_spline_", seq_len(ncol(spline_basis)))

pt_stg <- bind_cols(pt_stg, spline_basis)

msm_5_hx_cov_spline <- msm(
  state_num ~ DaysSinceEntry,
  subject     = deid_enc_id,
  data        = pt_stg,
  qmatrix     = crude_rates[["hx_sev"]]$qmat,
  covariates  = ~ hx_spline_1 + hx_spline_2 + hx_spline_3,
  control     = list(fnscale = 10000, maxit = 1000)
)
```


```{r fit-4state-hx-cov}

# Fit 4-state model with hx_sev_time covariate

pt_stg4 <- pt_stg_raw %>%
  dplyr::filter(model == "base_model")

msm_4_hx_cov <- msm(
  state_num ~ DaysSinceEntry,
  subject     = deid_enc_id,
  data        = pt_stg4,
  qmatrix     = crude_rates[["base_model"]]$qmat,
  covariates  = ~ hx_sev_time,
  control     = list(fnscale = 10000, maxit = 1000)
)

spline_basis_4 <- as.data.frame(splines::ns(pt_stg4$hx_sev_time, df = 3))
names(spline_basis_4) <- paste0("hx_spline_", seq_len(ncol(spline_basis_4)))
pt_stg4 <- bind_cols(pt_stg4, spline_basis_4)

msm_4_hx_cov_spline <- msm(
  state_num ~ DaysSinceEntry,
  subject     = deid_enc_id,
  data        = pt_stg4,
  qmatrix     = crude_rates[["base_model"]]$qmat,
  covariates  = ~ hx_spline_1 + hx_spline_2 + hx_spline_3,
  control     = list(fnscale = 10000, maxit = 1000)
)

# Compare AIC and LR test
fit_cmp <- tibble(
  Model               = c("4‑state (base)", "4‑state + hx_sev_time", "4‑state + hx_sev_time (spline)"),
  AIC                 = c(AIC(fitted_models[["base_model"]]), AIC(msm_4_hx_cov), AIC(msm_4_hx_cov_spline))
)

fit_cmp %>%
  mutate(AIC = round(AIC, 2)) %>%
  kable(caption = "AIC comparison for 4‑state models with/without hx_sev_time") %>%
  kable_styling(full_width = FALSE)

```

```{r lrtest-table, echo=FALSE}

lr_res <- lrtest.msm(fitted_models[["base_model"]], msm_4_hx_cov)
lr_res_spline <- lrtest.msm(fitted_models[["base_model"]], msm_4_hx_cov_spline)

lr_tab <- tibble(
  Model = c("Log-linear", "Spline (df = 3)"),
  `-2 log LR` = round(c(unname(lr_res[1]), unname(lr_res_spline[1])), 2),
  df          = c(unname(lr_res[2]), unname(lr_res_spline[2])),
  `p‑value`   = signif(c(unname(lr_res[3]), unname(lr_res_spline[3])), 3)
)

# Display
lr_tab %>%
  kable(caption = "Likelihood‑ratio tests for inclusion of `hx_sev_time` (vs. base model)") %>%
  kable_styling(full_width = FALSE)

```

The likelihood‑ratio (LR) statistic compares the goodness‑of‑fit of the 4‑state base model without any covariates versus the same model with `hx_sev_time`. p < 0.05) indicates that adding the covariate yields an improvement in fit.

```{r plot-spline-transition-intensities, message=FALSE, warning=FALSE}

# 1. Transition matrix and states
qmat <- crude_rates[["base_model"]]$qmat
states <- rownames(qmat)

# 2. Build transition lookup table (exclude D and R)
transitions <- as.data.frame(qmat) %>%
  rownames_to_column("from") %>%
  pivot_longer(-from, names_to = "to", values_to = "val") %>%
  dplyr::filter(val != 0, !from %in% c("D", "R")) %>%
  mutate(
    transition = paste0(from, " → ", to),
    from_idx = match(from, states),
    to_idx = match(to, states)
  )

# 3. Build prediction grid over hx_sev_time
hx_grid <- tibble(hx_sev_time = seq(
  min(pt_stg$hx_sev_time, na.rm = TRUE),
  max(pt_stg$hx_sev_time, na.rm = TRUE),
  length.out = max(pt_stg$hx_sev_time, na.rm = TRUE) - min(pt_stg$hx_sev_time, na.rm = TRUE) + 1
))

spline_basis <- as.data.frame(ns(hx_grid$hx_sev_time, df = 3))
colnames(spline_basis) <- paste0("hx_spline_", seq_len(ncol(spline_basis)))

hx_grid <- bind_cols(hx_grid, spline_basis)

# 4. Predict Q-matrices at each hx_sev_time
cov_list <- pmap(
  hx_grid %>% select(starts_with("hx_spline_")),
  ~ list(hx_spline_1 = ..1, hx_spline_2 = ..2, hx_spline_3 = ..3)
)

plan(multisession, workers = n.cores)


qlist_ci <- future_map(
  cov_list,
  ~ msm::qmatrix.msm(
      msm_4_hx_cov_spline,
      covariates = .x,
      ci = "normal"
    ),
  .options = furrr_options(seed = TRUE)  # seed for reproducibility
)

length(qlist_ci)        # should be 100
names(qlist_ci[[1]])    # should include: estimates, L, U, etc.

qlist_est <- map(qlist_ci, "estimates")
qlist_lwr <- map(qlist_ci, "L")
qlist_upr <- map(qlist_ci, "U")

# 8. Tidy results using map + list_rbind
intensity_preds <- map2(
  qlist_est,
  seq_along(qlist_est),
  function(q_est, i) {
    q_lwr <- qlist_lwr[[i]]
    q_upr <- qlist_upr[[i]]
    hx_val <- hx_grid$hx_sev_time[i]

    tibble(
      transition   = transitions$transition,
      hx_sev_time  = hx_val,
      estimate     = q_est[cbind(transitions$from_idx, transitions$to_idx)],
      lower        = q_lwr[cbind(transitions$from_idx, transitions$to_idx)],
      upper        = q_upr[cbind(transitions$from_idx, transitions$to_idx)]
    )
  }
) |> list_rbind()

# 6. Plot non-linear effect of hx_sev_time
ggplot(intensity_preds, aes(x = hx_sev_time, y = estimate)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "steelblue", alpha = 0.3) +
  geom_line(color = "steelblue", linewidth = 1) +
  facet_wrap(~ transition, scales = "free_y", nrow = 2) +
  labs(
    title = "Non-linear effect of hx_sev_time on transition intensities",
    subtitle = "Estimated using natural splines (df = 3) with 95% CI",
    x = "hx_sev_time",
    y = "Transition intensity (per day)"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))
```

#### Transition probabilities across values of `hx_sev_time`

### 5-day transition probabilities

```{r pmat-hx-5day}

# 1. Predict transition probability matrices with CIs
plist_ci_5day <- future_map(
  cov_list,
  ~ msm::pmatrix.msm(
      msm_4_hx_cov_spline,
      covariates = .x,
      t = 5,
      ci = "normal"
    ),
  .options = furrr_options(seed = TRUE)
)

# 2. Extract estimates + CI bounds
plist_est <- map(plist_ci_5day, "estimates")
plist_lwr <- map(plist_ci_5day, "L")
plist_upr <- map(plist_ci_5day, "U")

# 3. Define all transition pairs (excluding D/R as from-state)
trans_probs <- expand_grid(
  from = states[!states %in% c("D", "R")],
  to = states
) %>%
  mutate(
    from_idx = match(from, states),
    to_idx = match(to, states),
    transition = paste0(from, " → ", to),
    type = case_when(
      from == to ~ "staying",
      from == "M" & to == "S" ~ "worsening",
      from == "S" & to == "D" ~ "death",
      from == "M" & to == "R" ~ "recovery",
      from == "S" & to == "R" ~ "recovery",
      TRUE ~ "other"
    )
  )

# 4. Extract probabilities + CIs
prob_preds <- map2(
  plist_est, seq_along(plist_est),
  function(pmat, i) {
    tibble(
      transition = trans_probs$transition,
      hx_sev_time = hx_grid$hx_sev_time[i],
      probability = pmat[cbind(trans_probs$from_idx, trans_probs$to_idx)],
      lower       = plist_lwr[[i]][cbind(trans_probs$from_idx, trans_probs$to_idx)],
      upper       = plist_upr[[i]][cbind(trans_probs$from_idx, trans_probs$to_idx)],
      type        = trans_probs$type
    )
  }
) |> list_rbind()

# Optional: remove self-transitions (staying)
prob_preds <- filter(prob_preds, type != "staying")

# 5. Get baseline (no-covariate) 5-day probs from base model
base_pmat <- msm::pmatrix.msm(
  fitted_models[["base_model"]],
  t = 5
)

baseline_probs <- trans_probs %>%
  filter(type != "staying") %>%
  mutate(
    probability = base_pmat[cbind(from_idx, to_idx)]
  ) %>%
  select(transition, type, baseline = probability)

# 6. Join baseline lines to overlay in the plot
prob_preds <- left_join(prob_preds, baseline_probs, by = c("transition", "type"))

# 7. Plot
ggplot(prob_preds, aes(x = hx_sev_time, y = probability, color = type)) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = type), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_hline(aes(yintercept = baseline, color = type), linetype = "dashed", data = baseline_probs) +
  facet_wrap(~ transition, scales = "free_y") +
  labs(
    title = "5-day Transition Probabilities by hx_sev_time (Spline Model)",
    subtitle = "Shaded = 95% CI; Dashed = No-covariate baseline",
    x = "hx_sev_time",
    y = "Probability",
    color = "Transition type",
    fill = "Transition type"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))
```


