---
title: "Multi-State Model Analysis: Model Structures"
date: today
format:
  html:
    df-print: paged
    toc: true
    toc-float: true
    toc-depth: 3
    code-fold: true
    theme: default
    embed-resources: true
editor: source
editor_options: 
  markdown: 
    wrap: 72
execute:
  cache: false
---

```{r}
#| label: setup
#| include: false

rm(list = ls())

library(here)
library(tidyverse)
library(knitr)
library(kableExtra)
library(tableone)
library(Hmisc)
library(ggpubr)
library(viridis)

```

```{r}
#| label: load-data
#| include: false

source(here("R", "00-config.R"))
source(here("R", "00x-fns-tbl_figs.R"))

pt_stg <- readRDS(here("data", "pt_stg.rds"))

base_models <- readRDS(here("data", "base_models.rds"))
base_comp <- readRDS(here("data", "base_comp.rds"))
base_structure_comp <- readRDS(here("data", "base_structure_comp.rds"))
base_cv <- readRDS(here("data", "cv_results", "base", "cv_summary_all_models.rds"))
base_cv_metadata <- readRDS(here("data", "cv_results", "base", "cv_metadata.rds"))
```

# Model structure descriptives

## State space diagrams

![State space diagram](images/state-space.png)

## Statetables

### By stage

Frequency of each pair of stages being observed in successive days

```{r}
#| label: stage-table
#| echo: true
#| fig-width: 5
#| fig-height: 4

stage_table <- statetable.msm(stage, deid_enc_id, data = subset(pt_stg, model == "base_model"))

stage_df <- as.data.frame(stage_table) %>%
  mutate(across(c(from, to), as.character)) %>%
  mutate(
    from = factor(from, levels = rev(stage_order)),
    to = factor(to, levels = stage_order),
    Freq = ifelse(Freq == 0, NA, Freq)
  )

ggplot(data = stage_df, aes(x = to, y = from, fill = Freq)) +
  geom_tile(color = "white", size = 0.1) +
  geom_text(aes(label = scales::comma(Freq)), color = "white", size = 2.5, fontface = "bold") +
  scale_fill_viridis_c(
    name = "Count", 
    trans = "log10", 
    na.value = "white", 
    limits = c(1, NA),
    breaks = c(1, 10, 100, 1000),
    labels = c("1", "10", "100", "1000"),
    direction = -1,
    option = "mako"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom") +
  labs(x = "To Stage", y = "From Stage")
  
```

### By state

Frequency of each pair of states being observed in successive days

```{r}
#| label: state-table
#| echo: true
#| fig-width: 9

get_state_table <- function(model_name) {
  model_data <- subset(pt_stg, model == model_name)
  st <- statetable.msm(state, deid_enc_id, data = model_data)
  st_df <- as.data.frame(st) %>%
    mutate(across(c(from, to), as.character)) %>%
    filter(from %in% state_order, to %in% state_order) %>%
    mutate(
      from = factor(from, levels = rev(state_order)),
      to = factor(to, levels = state_order),
      Freq = ifelse(Freq == 0, NA, Freq)
    )
  return(st_df)
}

plot_data <- map(names(models), get_state_table)
names(plot_data) <- models

create_tile_plot <- function(data, model_name) {
  ggplot(data, aes(x = to, y = from, fill = Freq)) +
    geom_tile(color = "white", size = 0.1) +
    geom_text(aes(label = scales::comma(Freq)), color = "white", size = 2.5, fontface = "bold") +
    scale_fill_viridis_c(
      name = "Count", 
      trans = "log10", 
      na.value = "white", 
      limits = c(1, 10000),
      breaks = c(1, 10, 100, 1000, 10000),
      labels = c("1", "10", "100", "1000", "10000"),
      direction = -1,
      option = "mako"
    ) +
    theme_minimal(base_size = 14) +
    labs(x = "To State", y = "From State", title = model_name)
}

plot_list <- map2(plot_data, names(plot_data), create_tile_plot)

combined_plot <- ggarrange(
  plotlist = plot_list,
  nrow = 2, 
  ncol = 3,
  common.legend = TRUE,
  legend = "bottom"
)

combined_plot

```

# Model Structure: Overall results

## Transition intensity estimates

```{r}
#| label: transition-intensities-prep
#| echo: true

qmat_data <- base_comp[["qmatrix"]]
qmat_data <- qmat_data %>%
  dplyr::select(model_name, statename, tostatename, 
                estimate, conf.low, conf.high) %>%
  rename(
    model = model_name,
    from = statename,
    to = tostatename,
    q_estimate = estimate,
    q_conf_low = conf.low,
    q_conf_high = conf.high
  ) %>%
  left_join(models_df, by = "model") %>%
  left_join(trend_types, by = c("from", "to"))

x_limit <- 0.4

qmat_data <- qmat_data %>%
  mutate(
    q_conf_high_capped = pmin(q_conf_high, x_limit),
    needs_arrow = q_conf_high > x_limit,
    from = factor(from, levels = state_order),
    to = factor(to, levels = state_order),
    transition = paste0(from, " → ", to),
    transition = factor(transition, levels = paste0(rep(state_order, each = length(state_order)), 
                                                   " → ", 
                                                   rep(state_order, times = length(state_order))))
  ) %>%
  filter(transition %in% unique(transition)) %>%
  mutate(model_name = factor(model_name, levels = models_df$model_name)) %>%
  mutate(text = format_ci(q_estimate, q_conf_low, q_conf_high, digits = 2))

```

```{r}
#| label: transition-intensities-table
#| echo: true

kable(qmat_data %>%
        dplyr::filter(model == "base_model") %>%
        dplyr::select(model_name, transition, trend, 
                      text) %>%
        arrange(model_name, transition),
      col.names = c("Model Structure", "Transition", "Trend", 
                    "Transition intensity (per day)"),
      digits = c(0, 0, 0, 3, 3, 3)) %>%
  kable_styling(full_width = FALSE) %>%
  row_spec(0, bold = TRUE)

```

```{r}
#| label: transition-intensities-plot
#| echo: true
#| fig.width: 7
#| fig.height: 6

ggplot(qmat_data, aes(x = q_estimate, y = fct_rev(transition), color = trend)) +
  geom_point(size = 2.5) +
  # Error bars with capped upper limits
  geom_errorbarh(aes(xmin = q_conf_low, xmax = q_conf_high_capped), height = 0.2) +
  # Add arrows for truncated confidence intervals
  geom_segment(data = filter(qmat_data, needs_arrow),
               aes(x = x_limit - 0.01, xend = x_limit - 0.005, 
                   y = fct_rev(transition), yend = fct_rev(transition)),
               arrow = arrow(length = unit(0.1, "cm"), type = "closed"),
               linewidth = 0.8) +
  facet_wrap(~ model_name, scales = "free_y") +
  scale_x_continuous(limits = c(0, x_limit)) +
  scale_color_manual(values = trend_colors) +
  labs(x = "Fitted transition intensity (per day)", y = "Transition") +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"),
        legend.position = "bottom")

```

## Transition probabilities

```{r}
#| label: transition-probabilities-prep
#| echo: true

pmat_data <- base_comp[["pmats"]]

pmat_data <- pmat_data %>%
  dplyr::select(model_name, statename, tostatename, t_value, 
                estimate, conf.low, conf.high) %>%
  rename(
    model = model_name,
    from = statename,
    to = tostatename,
    time_days = t_value,
    p_estimate = estimate,
    p_conf_low = conf.low,
    p_conf_high = conf.high
  ) %>%
  left_join(models_df, by = "model")

pmat_data <- add_transition_trends(pmat_data)

time_points <- unique(pmat_data$time_days)

pmat_data <- pmat_data %>%
  mutate(
    from = factor(from, levels = state_order),
    to = factor(to, levels = state_order),
    transition = paste0(from, " → ", to),
    transition = factor(transition, levels = paste0(rep(state_order, each = length(state_order)), 
                                                   " → ", 
                                                   rep(state_order, times = length(state_order))))
  ) %>%
  filter(transition %in% unique(transition)) %>%
  mutate(model_name = factor(model_name, levels = models_df$model_name)) %>%
  mutate(text = format_ci(p_estimate, p_conf_low, p_conf_high, digits = 2)) %>%
  drop_na()

```

```{r}
#| label: transition-probabilities-table
#| echo: true

kable(pmat_data %>%
        dplyr::filter(model == "base_model") %>%
        dplyr::select(model_name, time_days, transition, trend, text) %>%
        arrange(model_name, transition),
      col.names = c("Model Structure", "Time (days)", "Transition", "Trend", 
                    "Transition probability"),
      digits = c(0, 0, 0, 0, 2, 2, 2)) %>%
  kable_styling(full_width = FALSE) %>%
  row_spec(0, bold = TRUE)

```

```{r}
#| label: transition-probabilities-plot-1
#| echo: true

plot_pmat_by_model <- function(model_name, nrows, ncols, data = pmat_data, model_title = NULL) {
  model_data <- pmat_data[pmat_data$model == model_name, ]
  p <- ggplot(model_data, aes(x = time_days, y = p_estimate, color = trend)) +
    geom_line(linewidth = 1) +
    geom_ribbon(aes(ymin = p_conf_low, ymax = p_conf_high), alpha = 0.2) +
    # facet_wrap(~ transition, nrow = nrows, ncol = ncols) +
    facet_grid(from~to, 
               labeller = labeller(
                 from = function(x) paste0("from = ", x),
                 to = function(x) paste0("to = ", x)
                 )) +
    scale_color_manual(values = trend_colors) +
    labs(x = "Time (days)", y = "Transition probability", title = model_title) +
    ylim(c(0, 1)) +
    theme_minimal() +
    theme(strip.text = element_text(face = "bold"),
          legend.position = "bottom")
  return(p)
}

pmat_plots <- models_df %>%
  mutate(nrows = c(2, 2, 3, 3, 4, 3),
         ncols = c(4, 4, 5, 5, 6, 5)) %>%
  pmap(function(model, nrows, ncols, model_name, ...) {
    plot_pmat_by_model(model, nrows, ncols, data = pmat_data, model_title = model_name)
  })

pmat_plots

```

```{r}
#| label: transition-probabilities-plot-2
#| echo: true

ggplot(data = pmat_data, aes(y = transition, color = trend, alpha = time_days, group = time_days)) +
  geom_point(aes(x = p_estimate), size = 2.5) +
  geom_errorbarh(aes(xmin = p_conf_low, xmax = p_conf_high), height = 0.2) +
  facet_wrap(~ model_name, scales = "free_y") +
  scale_x_continuous(limits = c(0, 1), name = "Probability of transition") +
  scale_color_manual(values = trend_colors) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.title.y = element_blank())

```

```{r}
#| label: transition-probabilities-plot-3
#| echo: true

# Separate by from type and to type?

```

## Sojourn times

```{r}
#| label: sojourn-times-prep
#| echo: true

## Temp sojourn
source(here("R", "00b-fns-model_eval.R"))
temp <- tidy_msm_sojourns(base_models, ci_method = "normal")
base_comp[["sojourns"]] <- temp

sojourn_data <- base_comp[["sojourns"]]
sojourn_data <- sojourn_data %>%
  dplyr::select(model_name, state, estimates, L, U) %>%
  rename(
    model = model_name,
    sojourn_estimate = estimates,
    sojourn_conf_low = L,
    sojourn_conf_high = U
  ) %>%
  left_join(models_df, by = "model") %>%
  mutate(
    state = factor(state, levels = state_order),
    model_name = factor(model_name, levels = models_df$model_name),
    text = format_ci(sojourn_estimate, sojourn_conf_low, sojourn_conf_high, digits = 2),
    state_type = ifelse(grepl("M", state) == TRUE, "Moderate", "Severe")
  )

```

```{r}
#| label: sojourn-times-table
#| echo: true

kable(sojourn_data %>%
        dplyr::select(model_name, state, text),
  col.names = c("Model", "State", "Mean sojourn time (days)")) %>%
  kable_styling(full_width = FALSE)
  
```

```{r}
#| label: sojourn-times-plot-1
#| echo: true

ggplot(sojourn_data, 
       aes(x = sojourn_estimate, y = fct_rev(state), color = state_type),
       alpha = 0.6) +
  geom_point(size = 2.5) +
  geom_errorbarh(aes(xmin = sojourn_conf_low, xmax = sojourn_conf_high), height = 0.2) +
  facet_wrap(~ model_name, scales = "free_y") +
  labs(x = "Mean sojourn time (days)", y = "State") +
  theme_minimal() +
  scale_color_manual(breaks = c("Moderate", "Severe"), 
                     values = c("#660066", "#336666"),
                     name = "State type") +
  theme(strip.text = element_text(face = "bold"),
        legend.position = "bottom") +
  xlim(c(0, NA))

```

```{r}
#| label: sojourn-times-plot-2
#| echo: true

ggplot(sojourn_data, 
       aes(x = sojourn_estimate, y = fct_rev(state), color = model_name),
       alpha = 0.6) +
  geom_point(size = 2.5, position = position_dodge(width = 1)) +
  geom_errorbarh(aes(xmin = sojourn_conf_low, xmax = sojourn_conf_high), 
                 height = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ state_type, scales = "free_y", nrow = 2) +
  labs(x = "Mean sojourn time (days)", y = "State") +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"),
        legend.position = "bottom") +
  xlim(c(0, NA)) +
  scale_color_viridis_d(name = "Model structure")

```

## Model comparison

### Log likelihoods

```{r}
#| label: model-comparison-loglik
#| echo: true
  
model_comp_ll <- base_comp$model_summary %>%
  # dplyr::filter(model_name %in% mod_state_mods) %>%
  rename(model = model_name) %>%
  left_join(models_df, by = "model") %>%
  dplyr::select(model_name, n_params, loglik, AIC, BIC)

model_comp_ll %>%
  kable(col.names = c("Model", "Number of parameters", "Log-likelihood", "AIC", "BIC")) %>%
  kable_styling(full_width = FALSE)

model_comp_ll_long <- model_comp_ll %>%
  pivot_longer(cols = c(n_params, loglik, AIC, BIC), 
               names_to = "metric", values_to = "value") %>%
  mutate(metric = recode(metric, 
                         n_params = "Number of parameters", 
                         loglik = "Log-likelihood", 
                         AIC = "AIC", 
                         BIC = "BIC")) %>%
  group_by(metric) %>%
  mutate(rank = rank(-value, ties.method = "min"))

ggplot(subset(model_comp_ll_long, model_name != "Base model"), 
       aes(x = model_name)) +
  geom_point(aes(y = value)) +
  geom_label(aes(y = value, label = rank), size = 3) +
  geom_hline(data = subset(model_comp_ll_long, model_name == "Base model"), aes(yintercept = value), linetype = "dashed") +
  facet_wrap(~ metric, scales = "free_y", nrow = 4) +
  labs(x = "Model", y = "Value") +
  theme_minimal() +
  theme(legend.position = "none", axis.title = element_blank())

```

```{r}
#| label: model-comparisons-draic-drlcv
#| eval: false

models_comparison <- base_structure_comp %>%
  drop_na() %>%
  mutate(draic_text = format_ci(draic, draic_ll, draic_ul, digits = 1),
         drlcv_text = format_ci(drlcv, drlcv_ll, drlcv_ul, digits = 1)) %>%
  mutate(model1 = recode(model1_structure, !!!models),
         model2 = recode(model2_structure, !!!models)) %>%
  mutate(preferred_model_draic = ifelse(draic < 0, model1, model2),
         preferred_model_drlcv = ifelse(drlcv < 0, model1, model2))
  

kable(models_comparison %>% 
        dplyr::select(model1, model2, draic_text, drlcv_text, 
                      preferred_model_draic, preferred_model_drlcv),
      col.names = c("Model 1", "Model 2", 
                    "ΔrAIC (95% CI)", "ΔrLCV (95% CI)",
                    "Preferred model (ΔrAIC)", "Preferred model (ΔrLCV)"),
      digits = c(0, 0, 1, 1, 0, 0)) %>%
  kable_styling(full_width = FALSE) %>%
  row_spec(0, bold = TRUE)

```


```{r}
#| label: model-comparisons-pred-perf

rds_files <- list.files(
    path = here("data", "cv_results", "base"),
    pattern = "\\.rds$",
    ignore.case = TRUE,
    full.names = TRUE
)
  
# Read all files into a list
rds_data <- lapply(rds_files, readRDS)
  
# Extract file names (without path and extension) for naming
file_names <- tools::file_path_sans_ext(basename(rds_files))
names(rds_data) <- file_names

elements_to_remove <- c("cv_metadata", "cv_summary_all_models")
rds_data <- rds_data[!names(rds_data) %in% elements_to_remove]

tibble_name <- "fold_metrics"  # replace with your tibble name
column_name <- "model"      # replace with desired column name

combined_data <- map2_dfr(
  rds_data, 
  names(rds_data),
  ~ {
    if (tibble_name %in% names(.x)) {
      .x[[tibble_name]] %>%
        mutate(!!column_name := .y)
    } else {
      NULL  # Skip if tibble doesn't exist
    }
  }
)

combined_data <- combined_data %>%
  mutate(model = sub("^[^_]*_(.*)_[^_]*$", "\\1", model)) %>%
  left_join(models_df, by = c("model" = "model"))

pred_err_dat <- combined_data %>%
  dplyr::select(model_name, ends_with("_mae"), ends_with("_auc"), starts_with("brier_"), starts_with("calibration")) %>%
  pivot_longer(cols = -model_name, 
               names_to = "metric", values_to = "value")

pred_err_summ <- pred_err_dat %>%
  group_by(model_name, metric) %>%
  summarise(
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    median = median(value, na.rm = TRUE),
    IQR = IQR(value, na.rm = TRUE),
    n = n(),
    .groups = 'drop'
  )

# Brier = Mean squared error of probability predictions

ggplot(subset(pred_err_summ, model_name != "Base model")) +
  geom_point(aes(y = mean, x = model_name), size = 2.5) +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd, x = model_name), width = 0.2) +
  geom_hline(data = subset(pred_err_summ, model_name == "Base model"), aes(yintercept = mean), linetype = "dashed") +
  facet_wrap(~ metric, scales = "free_y", ncol = 2) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
#| label: model-comparisons-residuals

# # Calculate residuals
# raw_residual = 1 - expected_prob,
# pearson_residual = raw_residual / sqrt(expected_prob * (1 - expected_prob)),
# deviance_residual = sign(raw_residual) * sqrt(pmax(-2 * log(pmax(expected_prob, 1e-10)), 0)),

residuals_data <- base_comp[["residuals"]]



```

## State granularity

### Multiple moderate states


```{r}
#| label: moderate-states-model-comparison-prevalences
#| echo: true

mod_state_mods <- c("base_model", "mod_2", "mod_3")  

mod_prev <- base_comp$prevalence %>%
  dplyr::filter(model_name %in% mod_state_mods) %>%
  rename(model = model_name) %>%
  left_join(models_df, by = "model") %>%
  dplyr::select(model_name, time, state, observed_count, 
                expected_count, expected_count_ll, expected_count_ul,
                N_at_risk)

ggplot(data = subset(mod_prev, state %in% c("S", "D", "R")),
       aes(x = factor(time))) +
  geom_bar(aes(y = N_at_risk), 
           stat = "identity", alpha = 0.3) +
  geom_point(aes(y = observed_count, color = model_name), 
             shape = 5, size = 2, position = position_dodge(width = 1)) +
  geom_point(aes(y = expected_count, color = model_name), 
             size = 2, position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = expected_count_ll, 
                    ymax = expected_count_ul, color = model_name), 
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~state) +
  labs(x = "Time (days)", y = "Count") +
  theme_minimal() 

ggplot(data = subset(mod_prev, state %in% c("S", "D", "R")),
       aes(x = factor(time))) +
  geom_point(aes(y = observed_count, color = model_name), 
             shape = 5, size = 2, position = position_dodge(width = 1)) +
  geom_point(aes(y = expected_count, color = model_name), 
             size = 2, position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = expected_count_ll, 
                    ymax = expected_count_ul, color = model_name), 
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~state) +
  labs(x = "Time (days)", y = "Count") +
  theme_minimal() 

ggplot(data = subset(mod_prev, state %in% c("M", "M1", "M2", "M3")),
       aes(x = factor(time))) +
  geom_bar(aes(y = N_at_risk), 
           stat = "identity", alpha = 0.3) +
  geom_point(aes(y = observed_count, color = model_name, alpha = state), 
             shape = 5, size = 2, position = position_dodge(width = 1)) +
  geom_point(aes(y = expected_count, color = model_name, alpha = state), 
             size = 2, position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = expected_count_ll, 
                    ymax = expected_count_ul, color = model_name, alpha = state), 
                width = 0.2, position = position_dodge(width = 1)) +
  # facet_wrap(~state, scales = "free_y") +
  labs(x = "Time (days)", y = "Count") +
  theme_minimal() 

ggplot(data = subset(mod_prev, state %in% c("M", "M1", "M2", "M3")),
       aes(x = factor(time))) +
  geom_point(aes(y = observed_count, color = model_name, alpha = state), 
             shape = 5, size = 2, position = position_dodge(width = 1)) +
  geom_point(aes(y = expected_count, color = model_name, alpha = state), 
             size = 2, position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = expected_count_ll, 
                    ymax = expected_count_ul, color = model_name, alpha = state), 
                width = 0.2, position = position_dodge(width = 1)) +
  # facet_wrap(~state, scales = "free_y") +
  labs(x = "Time (days)", y = "Count") +
  theme_minimal() +
  scale_alpha_manual(values = c(1, 1, 0.5, 0.3), name = "State", breaks = c("M", "M1", "M2", "M3"))


```

### Multiple severe states

```{r}
#| label: severe-states-model-comparison-prevalences
#| echo: true

sev_state_mods <- c("base_model", "sev_2")

sev_prev <- base_comp$prevalence %>%
  dplyr::filter(model_name %in% sev_state_mods) %>%
  rename(model = model_name) %>%
  left_join(models_df, by = "model") %>%
  dplyr::select(model_name, time, state, observed_count, 
                expected_count, expected_count_ll, expected_count_ul,
                N_at_risk) %>%
  mutate(state_type = ifelse(grepl("S", state) == TRUE, "S", state))

ggplot(data = sev_prev, aes(x = factor(time))) +
  geom_bar(aes(y = N_at_risk), 
           stat = "identity", alpha = 0.3) +
  geom_point(aes(y = observed_count, color = model_name, alpha = state), 
             shape = 5, size = 2, position = position_dodge(width = 1)) +
  geom_point(aes(y = expected_count, color = model_name, alpha = state), 
             size = 2, position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = expected_count_ll, 
                    ymax = expected_count_ul, 
                    color = model_name, alpha = state), 
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~state_type, scales = "free_y") +
  labs(x = "Time (days)", y = "Count") +
  theme_minimal() +
  scale_alpha_manual(values = c(1, 1, 0.5, 1, 1, 1), 
                     breaks = c("S", "S1", "S2", "M", "R", "D"),
                     name = "State")
  
ggplot(data = sev_prev, aes(x = factor(time))) +
  geom_point(aes(y = observed_count, color = model_name, alpha = state), 
             shape = 5, size = 2, position = position_dodge(width = 1)) +
  geom_point(aes(y = expected_count, color = model_name, alpha = state), 
             size = 2, position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = expected_count_ll, 
                    ymax = expected_count_ul, 
                    color = model_name, alpha = state), 
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~state_type, scales = "free_y") +
  labs(x = "Time (days)", y = "Count") +
  theme_minimal() +
  scale_alpha_manual(values = c(1, 1, 0.5, 1, 1, 1), 
                     breaks = c("S", "S1", "S2", "M", "R", "D"),
                     name = "State")
```

## Transition structure

### Simplified transitions

```{r}
#| label: simplified-transitions-model-comparison-prevalences
#| echo: true

simp_trans_mods <- c("base_model", "reduced_trans")

trans_prev <- base_comp$prevalence %>%
  dplyr::filter(model_name %in% simp_trans_mods) %>%
  rename(model = model_name) %>%
  left_join(models_df, by = "model") %>%
  dplyr::select(model_name, time, state, observed_count, 
                expected_count, expected_count_ll, expected_count_ul,
                N_at_risk)
  
ggplot(trans_prev, aes(x = factor(time))) +
  geom_bar(aes(y = N_at_risk), 
           stat = "identity", alpha = 0.3) +
  geom_point(aes(y = observed_count, color = model_name), 
             shape = 5, size = 2, position = position_dodge(width = 1)) +
  geom_point(aes(y = expected_count, color = model_name), 
             size = 2, position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = expected_count_ll, 
                    ymax = expected_count_ul, color = model_name), 
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~state, scales = "free_y") +
  labs(x = "Time (days)", y = "Count") +
  theme_minimal()

ggplot(trans_prev, aes(x = factor(time))) +
  geom_point(aes(y = observed_count, color = model_name), 
             shape = 5, size = 2, position = position_dodge(width = 1)) +
  geom_point(aes(y = expected_count, color = model_name), 
             size = 2, position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = expected_count_ll, 
                    ymax = expected_count_ul, color = model_name), 
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~state) +
  labs(x = "Time (days)", y = "Count") +
  theme_minimal()

```

