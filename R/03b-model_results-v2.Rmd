---
title: "Comprehensive Multi-State Model Analysis: Enhanced Results"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
    code_folding: show
    theme: flatly
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 8)

rm(list = ls())

library(here)
library(tidyverse)
library(kableExtra)
library(patchwork)
library(plotly)
library(DT)
library(msm)

options(knitr.kable.NA = "-")
```

```{r load-data, include = FALSE}
source(here("R", "00-config.R"))
source(here("R", "00-functions.R"))

# Load comprehensive results
comprehensive_results <- readRDS(here("data", "temp", "comprehensive_model_results.rds"))

# Extract components
base_models <- comprehensive_results$base_models
covariate_models <- comprehensive_results$covariate_models
time_varying_models <- comprehensive_results$time_varying_models
sensitivity_results <- comprehensive_results$sensitivity_results
predictive_performance <- comprehensive_results$predictive_performance
diagnostic_results <- comprehensive_results$diagnostics

# Model statistics
covariate_stats <- comprehensive_results$model_statistics$covariate_stats
time_varying_stats <- comprehensive_results$model_statistics$time_varying_stats
transition_stats <- comprehensive_results$model_statistics$transition_stats

# Model comparisons
same_structure_comparisons <- comprehensive_results$model_comparisons$same_structure
different_structure_comparisons <- comprehensive_results$model_comparisons$different_structure
sensitivity_comparison <- comprehensive_results$model_comparisons$sensitivity

```

# Executive Summary

This report presents a comprehensive analysis of multi-state Markov models for COVID-19 clinical trajectories. The analysis includes:

- **`r length(base_models)` base model structures** with different state configurations
- **`r length(unique(covariate_stats$covariate_type))` covariate specifications** including linear and spline terms
- **Time-varying transition rates** to assess violation of Markov assumptions
- **Transition-specific covariate effects** to understand heterogeneous effects
- **Sensitivity analyses** for outliers and model robustness
- **Cross-validation assessment** of predictive performance

## Key Findings

```{r executive-summary, echo = FALSE}
# Calculate key summary metrics
n_patients <- comprehensive_results$data_info$n_patients
n_observations <- comprehensive_results$data_info$n_observations
n_long_stay <- comprehensive_results$data_info$long_stay_patients

# Best performing model by AIC
best_base_model <- same_structure_comparisons$base_models %>%
  filter(!is.na(AIC)) %>%
  arrange(AIC) %>%
  slice(1) %>%
  pull(model)

# Most significant covariate
best_covariate <- covariate_stats %>%
  filter(!is.na(lrt_pval), converged == TRUE) %>%
  arrange(lrt_pval) %>%
  slice(1)

cat("Dataset Summary:\n")
cat("• Total patients:", n_patients, "\n")
cat("• Total observations:", n_observations, "\n") 
cat("• Long-stay patients (>30 days):", n_long_stay, "\n")
cat("\nModel Performance:\n")
cat("• Best base model structure:", best_base_model, "\n")
cat("• Most significant covariate:", best_covariate$covariate_type, 
    "for", best_covariate$model, "(p =", round(best_covariate$lrt_pval, 4), ")\n")
```

# Base Model Comparison

## Model Structure Comparison (DRAIC/DRLCV)

```{r structural-comparison}
if (!is.null(different_structure_comparisons) && nrow(different_structure_comparisons) > 0) {
  different_structure_comparisons %>%
    select(model1, model2, draic, draic_pval, drlcv, drlcv_pval) %>%
    mutate(across(where(is.numeric), ~round(.x, 3))) %>%
    kable(caption = "Structural Model Comparisons (DRAIC and DRLCV)", 
          col.names = c("Model 1", "Model 2", "ΔRAIC", "ΔRAIC p-value", 
                       "ΔRLCV", "ΔRLCV p-value")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
} else {
  cat("Structural model comparisons not available or failed to compute.")
}
```

Positive values for these criteria indicate the coarse model is preferred, while negative values indicate the full model is preferred.

# Covariate Analysis

## Univariate Covariate Effects

### Model Convergence Summary

```{r covariate-convergence}
convergence_summary <- covariate_stats %>%
  separate(covariate_type, c("covariate", "type"), sep = "_", extra = "merge") %>%
  group_by(covariate, type) %>%
  summarise(
    n_models = n(),
    n_converged = sum(converged, na.rm = TRUE),
    convergence_rate = round(n_converged / n_models * 100, 1),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(n_converged, convergence_rate), 
              names_sep = "_") %>%
  arrange(desc(convergence_rate_linear))

convergence_summary %>%
  kable(caption = "Covariate Model Convergence Rates") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

### Significant Covariate Effects

```{r significant-covariates}
significant_covariates <- covariate_stats %>%
  filter(converged == TRUE, !is.na(lrt_pval)) %>%
  mutate(
    significant = lrt_pval < 0.05,
    highly_significant = lrt_pval < 0.001
  ) %>%
  arrange(lrt_pval)

significant_covariates %>%
  select(covariate_type, model, delta_AIC, delta_BIC, lrt_stat, lrt_pval) %>%
  mutate(
    delta_AIC = round(delta_AIC, 1),
    delta_BIC = round(delta_BIC, 1),
    lrt_stat = round(lrt_stat, 2),
    lrt_pval = ifelse(lrt_pval < 0.001, "<0.001", round(lrt_pval, 3))
  ) %>%
  kable(caption = "Top 20 Most Significant Covariate Effects") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which(significant_covariates$lrt_pval < 0.001), bold = TRUE)
```

### Linear vs. Spline Comparison for Continuous Variables

```{r linear-vs-spline}
continuous_comparison <- covariate_stats %>%
  filter(str_detect(covariate_type, "age|BMI|cci_score|COVID_vax_doses")) %>%
  separate(covariate_type, c("covariate", "type"), sep = "_", extra = "merge") %>%
  filter(type %in% c("linear", "spline"), converged == TRUE) %>%
  select(covariate, type, model, AIC, lrt_pval) %>%
  pivot_wider(names_from = type, values_from = c(AIC, lrt_pval), names_sep = "_") %>%
  mutate(
    delta_AIC_spline_vs_linear = AIC_spline - AIC_linear,
    prefer_spline_AIC = delta_AIC_spline_vs_linear < -2
  )

continuous_comparison %>%
  select(covariate, model, delta_AIC_spline_vs_linear, 
         prefer_spline_AIC, lrt_pval_linear, lrt_pval_spline) %>%
  mutate(across(starts_with("delta"), ~round(.x, 1))) %>%
  kable(caption = "Linear vs. Spline Model Comparison for Continuous Variables") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Covariate Effect Visualization

```{r covariate-effects-plot, fig.height=10}
# Plot AIC improvements for all covariates
covariate_plot_data <- covariate_stats %>%
  filter(converged == TRUE, !is.na(delta_AIC)) %>%
  separate(covariate_type, c("covariate", "type"), sep = "_", extra = "merge") %>%
  mutate(
    type = replace_na(type, "linear"),
    improvement = -delta_AIC,  # Negative delta_AIC means improvement
    significant = ifelse(!is.na(lrt_pval), lrt_pval < 0.05, FALSE)
  )

p1 <- ggplot(covariate_plot_data, aes(x = improvement, y = reorder(paste(covariate, type), improvement))) +
  geom_col(aes(fill = significant)) +
  facet_wrap(~ model, scales = "free_x") +
  scale_fill_manual(values = c("FALSE" = "gray70", "TRUE" = "steelblue")) +
  labs(
    title = "AIC Improvement by Covariate",
    subtitle = "Colored bars indicate statistically significant effects (p < 0.05)",
    x = "AIC Improvement (negative ΔAIC)",
    y = "Covariate",
    fill = "Significant"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8))

print(p1)
```

# Time-Varying Transition Rates

## Model Comparison

```{r time-varying-comparison}
time_varying_stats %>%
  select(covariate_type, model, delta_AIC, delta_BIC, lrt_stat, lrt_pval) %>%
  filter(!is.na(lrt_pval)) %>%
  mutate(across(c(delta_AIC, delta_BIC, lrt_stat), ~round(.x, 2))) %>%
  mutate(lrt_pval = ifelse(lrt_pval < 0.001, "<0.001", round(lrt_pval, 3))) %>%
  # arrange(lrt_pval) %>%
  kable(caption = "Time-Varying Rate Model Comparison") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r time-varying-interpretation}
# Interpretation of time-varying effects
time_varying_significant <- time_varying_stats %>%
  filter(!is.na(lrt_pval), lrt_pval < 0.05)

if (nrow(time_varying_significant) > 0) {
  cat("**Significant time-varying effects detected:**\n\n")
  cat("This suggests violation of the Markov assumption in the following models:\n")
  for (i in 1:nrow(time_varying_significant)) {
    cat("•", time_varying_significant$model[i], "with", time_varying_significant$covariate_type[i], 
        "effect (p =", round(time_varying_significant$lrt_pval[i], 3), ")\n")
  }
  cat("\nImplications:\n")
  cat("• Transition intensities change over time within hospitalizations\n")
  cat("• Standard Markov models may not adequately capture temporal dynamics\n")
  cat("• Consider time-stratified or semi-Markov models for these cases\n")
} else {
  cat("**No significant time-varying effects detected.**\n\n")
  cat("This supports the Markov assumption that transition rates are constant over time.")
}
```

# Transition-Specific Covariate Effects

```{r transition-specific-effects}
if (!is.null(transition_stats) && nrow(transition_stats) > 0) {
  transition_stats %>%
    filter(converged == TRUE, !is.na(lrt_pval)) %>%
    select(covariate_type, model, delta_AIC, lrt_pval) %>%
    arrange(lrt_pval) %>%
    mutate(
      delta_AIC = round(delta_AIC, 1),
      lrt_pval = ifelse(lrt_pval < 0.001, "<0.001", round(lrt_pval, 3))
    ) %>%
    kable(caption = "Transition-Specific Covariate Effects") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
} else {
  cat("Transition-specific effects analysis not available.")
}
```

# Sensitivity Analysis

## Long-Stay Patients (>30 days)

```{r sensitivity-analysis}
cat("Long-stay patients identified:", comprehensive_results$data_info$long_stay_patients, "\n")
cat("Percentage of total:", round(comprehensive_results$data_info$long_stay_patients / 
                                  comprehensive_results$data_info$n_patients * 100, 1), "%\n\n")

# Compare model fits with and without long-stay patients
if (!is.null(sensitivity_comparison$excluded_vs_original)) {
  sensitivity_comparison$excluded_vs_original %>%
    select(model, delta_AIC, delta_BIC) %>%
    filter(!is.na(delta_AIC)) %>%
    mutate(across(c(delta_AIC, delta_BIC), ~round(.x, 1))) %>%
    kable(caption = "Model Fit Change After Excluding Long-Stay Patients") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}

if (!is.null(sensitivity_comparison$truncated_vs_original)) {
  sensitivity_comparison$truncated_vs_original %>%
    select(model, delta_AIC, delta_BIC) %>%
    filter(!is.na(delta_AIC)) %>%
    mutate(across(c(delta_AIC, delta_BIC), ~round(.x, 1))) %>%
    kable(caption = "Model Fit Change After Truncating at Day 30") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

# Predictive Performance

## Cross-Validation Results

```{r predictive-performance}
if (!is.null(predictive_performance) && nrow(predictive_performance) > 0) {
  predictive_performance %>%
    arrange(total_los_mae_cv) %>%
    mutate(across(where(is.numeric), ~round(.x, 3))) %>%
    kable(caption = "Predictive Performance (5-Fold Cross-Validation)") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
    row_spec(1, bold = TRUE, color = "white", background = "darkgreen")
} else {
  cat("Predictive performance analysis not available.")
}

# Plot predictive performance
if (!is.null(predictive_performance) && nrow(predictive_performance) > 0) {
  p_pred <- predictive_performance %>%
    select(model, total_los_mae_cv, days_severe_mae_cv) %>%
    pivot_longer(cols = c(total_los_mae_cv, days_severe_mae_cv), 
                 names_to = "metric", values_to = "mae") %>%
    filter(!is.na(mae)) %>%
    ggplot(aes(x = mae, y = reorder(model, -mae), fill = metric)) +
    geom_col(position = "dodge") +
    scale_fill_manual(values = c("total_los_mae_cv" = "steelblue", 
                                "days_severe_mae_cv" = "coral")) +
    labs(
      title = "Cross-Validation Predictive Performance",
      subtitle = "Mean Absolute Error (lower is better)",
      x = "Mean Absolute Error",
      y = "Model",
      fill = "Outcome"
    ) +
    theme_minimal()
  
  print(p_pred)
}
```

# Model Diagnostics

## Deviance Analysis

```{r model-diagnostics, fig.height=12}
if (!is.null(diagnostic_results) && nrow(diagnostic_results) > 0) {
  # Plot deviance residuals
  p_deviance <- diagnostic_results %>%
    filter(!is.na(deviance), deviance > 0) %>%
    mutate(transition = paste(from_state, "→", to_state)) %>%
    ggplot(aes(x = expected_count, y = observed)) +
    geom_point(aes(size = deviance), alpha = 0.7) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
    facet_wrap(~ model, scales = "free") +
    scale_size_continuous(range = c(1, 4)) +
    labs(
      title = "Observed vs. Expected Transition Counts",
      subtitle = "Point size indicates deviance residual magnitude",
      x = "Expected Count",
      y = "Observed Count",
      size = "Deviance"
    ) +
    theme_minimal()
  
  print(p_deviance)
  
  # Summary table of largest deviances
  top_deviances <- diagnostic_results %>%
    filter(!is.na(deviance)) %>%
    arrange(desc(deviance)) %>%
    slice_head(n = 15) %>%
    mutate(
      transition = paste(from_state, "→", to_state),
      deviance = round(deviance, 2),
      expected_count = round(expected_count, 1)
    ) %>%
    select(model, transition, observed, expected_count, deviance)
  
  top_deviances %>%
    kable(caption = "Top 15 Largest Deviance Residuals") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

# Clinical Interpretations and Implications

## Model Selection Recommendations

```{r model-recommendations}
# Determine best overall model
best_models <- same_structure_comparisons$base_models %>%
  filter(converged == TRUE) %>%
  arrange(AIC) %>%
  slice_head(n = 3)

cat("**Recommended Models (by AIC):**\n\n")
for (i in 1:nrow(best_models)) {
  cat(i, ". **", best_models$model[i], "** (AIC =", round(best_models$AIC[i], 1), ")\n")
}

cat("\n**Key Clinical Implications:**\n\n")

# Identify most important covariates
top_covariates <- covariate_stats %>%
  filter(converged == TRUE, !is.na(lrt_pval), lrt_pval < 0.05) %>%
  arrange(lrt_pval) %>%
  slice_head(n = 5)

if (nrow(top_covariates) > 0) {
  cat("• **Significant predictors of clinical trajectory:**\n")
  for (i in 1:nrow(top_covariates)) {
    cat("  -", top_covariates$covariate_type[i], "in", top_covariates$model[i], 
        "(p =", round(top_covariates$lrt_pval[i], 4), ")\n")
  }
  cat("\n")
}

# Time-varying effects interpretation
if (nrow(time_varying_significant) > 0) {
  cat("• **Markov assumption violations detected:**\n")
  cat("  - Transition rates change over time in hospital\n")
  cat("  - Early vs. late hospitalization periods may have different risk profiles\n")
  cat("  - Consider time-stratified risk assessment\n\n")
}

# Sensitivity analysis interpretation
if (comprehensive_results$data_info$long_stay_patients > 0) {
  cat("• **Long-stay patient impact:**\n")
  cat("  -", comprehensive_results$data_info$long_stay_patients, "patients with stays >30 days\n")
  cat("  - These outliers may influence model estimates\n")
  cat("  - Clinical decision-making should account for this heterogeneity\n\n")
}
```

## Transition Probability Insights

```{r clinical-insights, fig.height=10}
# Load and display key transition probabilities from best model
best_model_name <- best_models$model[1]
best_model_obj <- base_models[[best_model_name]]

if (!is.null(best_model_obj)) {
  # 1-day and 5-day transition probabilities
  pmat_1day <- pmatrix.msm(best_model_obj, t = 1)
  pmat_5day <- pmatrix.msm(best_model_obj, t = 5)
  
  # Convert to tidy format for visualization
  pmat_1day_tidy <- as.data.frame(as.table(pmat_1day)) %>%
    rename(from = Var1, to = Var2, prob_1day = Freq) %>%
    filter(!from %in% c("D", "R"))
  
  pmat_5day_tidy <- as.data.frame(as.table(pmat_5day)) %>%
    rename(from = Var1, to = Var2, prob_5day = Freq) %>%
    filter(!from %in% c("D", "R"))
  
  # Combine and create heatmap
  pmat_combined <- pmat_1day_tidy %>%
    left_join(pmat_5day_tidy, by = c("from", "to")) %>%
    pivot_longer(cols = c(prob_1day, prob_5day), names_to = "timepoint", values_to = "probability")
  
  p_heatmap <- ggplot(pmat_combined, aes(x = to, y = from, fill = probability)) +
    geom_tile(color = "white") +
    geom_text(aes(label = round(probability, 3)), color = "white", size = 3) +
    facet_wrap(~ timepoint, labeller = labeller(timepoint = c(prob_1day = "1-Day", prob_5day = "5-Day"))) +
    scale_fill_gradient2(low = "navy", mid = "steelblue", high = "lightblue", 
                        midpoint = 0.5, name = "Probability") +
    labs(
      title = paste("Transition Probabilities -", best_model_name),
      subtitle = "Probability of transitioning from current state (rows) to future state (columns)",
      x = "To State",
      y = "From State"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  print(p_heatmap)
  
  # Key clinical probabilities table
  key_probs <- pmat_combined %>%
    filter(
      (from == "M" & to %in% c("S", "R", "D")) |
      (from == "S" & to %in% c("M", "R", "D"))
    ) %>%
    pivot_wider(names_from = timepoint, values_from = probability) %>%
    mutate(
      transition = paste(from, "→", to),
      prob_1day = round(prob_1day, 4),
      prob_5day = round(prob_5day, 3)
    ) %>%
    arrange(desc(prob_5day))
  
  key_probs %>%
    select(transition, prob_1day, prob_5day) %>%
    kable(caption = "Key Clinical Transition Probabilities", 
          col.names = c("Transition", "1-Day Probability", "5-Day Probability")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

## Expected Length of Stay Analysis

```{r los-analysis}
if (!is.null(best_model_obj)) {
  # Calculate mean sojourn times
  sojourn_times <- sojourn.msm(best_model_obj)
  
  sojourn_df <- data.frame(
    State = names(sojourn_times$estimates),
    Mean_Days = round(sojourn_times$estimates, 2),
    Lower_CI = round(sojourn_times$L, 2),
    Upper_CI = round(sojourn_times$U, 2)
  ) %>%
    filter(!State %in% c("D", "R"))
  
  sojourn_df %>%
    kable(caption = "Expected Time in Each State (Sojourn Times)", 
          col.names = c("State", "Mean (days)", "95% CI Lower", "95% CI Upper")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
  
  cat("\n**Clinical Interpretation:**\n")
  cat("• Patients in moderate states spend on average", 
      round(sojourn_df$Mean_Days[sojourn_df$State == "M"], 1), 
      "days before transitioning\n")
  
  if ("S" %in% sojourn_df$State) {
    cat("• Patients in severe states spend on average", 
        round(sojourn_df$Mean_Days[sojourn_df$State == "S"], 1), 
        "days before transitioning\n")
  }
}
```

# Risk Stratification Implications

```{r risk-stratification}
# Identify high-risk transitions and patient characteristics
if (!is.null(top_covariates) && nrow(top_covariates) > 0) {
  cat("## High-Risk Patient Identification\n\n")
  cat("Based on the significant covariates identified, the following patient characteristics\n")
  cat("are associated with different clinical trajectories:\n\n")
  
  # Extract covariate types
  risk_factors <- top_covariates %>%
    separate(covariate_type, c("covariate", "type"), sep = "_", extra = "merge") %>%
    mutate(type = replace_na(type, "linear")) %>%
    select(covariate, type, model, lrt_pval) %>%
    arrange(lrt_pval)
  
  for (i in 1:nrow(risk_factors)) {
    cat("•", toupper(risk_factors$covariate[i]), 
        "(", risk_factors$type[i], "effect in", risk_factors$model[i], "model)\n")
  }
  
  cat("\n**Recommendations for Clinical Practice:**\n\n")
  cat("1. **Risk Assessment:** Use identified covariates for admission risk stratification\n")
  cat("2. **Resource Planning:** Expected sojourn times can inform bed capacity planning\n")
  cat("3. **Monitoring Protocols:** High-risk transitions should trigger enhanced monitoring\n")
  cat("4. **Discharge Planning:** Transition probabilities can guide discharge timing decisions\n")
  
  if (nrow(time_varying_significant) > 0) {
    cat("5. **Dynamic Assessment:** Reassess risk profiles as hospitalization progresses\n")
  }
}
```

# Model Limitations and Future Directions

```{r limitations}
cat("## Current Analysis Limitations\n\n")

# Calculate convergence rates
overall_convergence <- covariate_stats %>%
  summarise(
    total_models = n(),
    converged_models = sum(converged, na.rm = TRUE),
    convergence_rate = round(converged_models / total_models * 100, 1)
  )

cat("• **Model Convergence:** ", overall_convergence$convergence_rate, "% of covariate models converged\n")
cat("• **Sample Size:** Analysis based on", comprehensive_results$data_info$n_patients, "patients\n")
cat("• **Missing Data:** Covariate effects may be biased by missing data patterns\n")
cat("• **Model Complexity:** Some transition-specific effects may be underexplored\n")

if (comprehensive_results$data_info$long_stay_patients > 0) {
  cat("• **Outliers:** ", comprehensive_results$data_info$long_stay_patients, 
      "long-stay patients may influence estimates\n")
}

cat("\n## Recommended Future Analyses\n\n")
cat("1. **Joint Modeling:** Incorporate longitudinal biomarkers and vital signs\n")
cat("2. **Competing Risks:** Explicitly model discharge vs. death as competing outcomes\n")
cat("3. **Semi-Markov Models:** Relax constant hazard assumption for time-varying effects\n")
cat("4. **External Validation:** Test models on independent patient populations\n")
cat("5. **Causal Inference:** Use methods to identify causal effects of interventions\n")
cat("6. **Real-time Implementation:** Develop tools for bedside risk calculation\n")

cat("\n## Data Quality Considerations\n\n")
cat("• **Temporal Resolution:** Daily observations may miss rapid clinical changes\n")
cat("• **State Definition:** Clinical staging criteria may need refinement\n")
cat("• **Covariate Measurement:** Time-varying covariates not fully incorporated\n")
cat("• **Selection Bias:** Analysis limited to hospitalized patients\n")
```

# Technical Appendix

## Model Specifications

```{r technical-appendix}
# Display Q-matrix structures for each model
qmat_list <- readRDS(here("data", "temp", "mod_qmat_list.rds"))

cat("### Transition Matrix Structures\n\n")
for (model_name in names(qmat_list)) {
  cat("**", model_name, ":**\n")
  cat("States:", paste(rownames(qmat_list[[model_name]]), collapse = ", "), "\n")
  cat("Allowed transitions:", sum(qmat_list[[model_name]] > 0), "out of", 
      length(qmat_list[[model_name]]), "possible\n\n")
}
```

## Computational Details

```{r computational-details}
cat("### Analysis Environment\n\n")
cat("• R version:", R.version.string, "\n")
cat("• msm package version:", packageVersion("msm"), "\n")
cat("• Parallel cores used:", n.cores, "\n")
cat("• Cross-validation folds:", 5, "\n")
cat("• Spline degrees of freedom:", 3, "\n")

# Model fitting summary
cat("\n### Model Fitting Summary\n\n")
cat("• Base models fitted:", length(base_models), "\n")
cat("• Covariate models attempted:", nrow(covariate_stats), "\n")
cat("• Successful fits:", sum(covariate_stats$converged, na.rm = TRUE), "\n")
cat("• Time-varying models:", nrow(time_varying_stats), "\n")

if (!is.null(different_structure_comparisons)) {
  cat("• Structural comparisons:", nrow(different_structure_comparisons), "\n")
}
```

---

*Report generated on `r Sys.Date()` using R `r R.version.string`*

**Contact:** For questions about this analysis, please contact the analysis team.

**Reproducibility:** All code and intermediate results are saved in the `data/temp/` directory. The comprehensive results object contains all fitted models and can be used to reproduce any part of this analysis.